<% include ../partials/top %>
<% include ../partials/dateRangePicker %>
<% include ../partials/header %>
	
	<div class="main-panel">
		<nav class="navbar navbar-transparent navbar-absolute">
                <div class="container-fluid">
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle" data-toggle="collapse">
                            <span class="sr-only">Toggle navigation</span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand" href="#"> Table List </a>
                    </div>
                    <div class="collapse navbar-collapse">
                        <ul class="nav navbar-nav navbar-right">
                            <li>
                                <a href="#pablo" class="dropdown-toggle" data-toggle="dropdown">
                                    <i class="material-icons">dashboard</i>
                                    <p class="hidden-lg hidden-md">Dashboard</p>
                                </a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                    <i class="material-icons">notifications</i>
                                    <span class="notification">5</span>
                                    <p class="hidden-lg hidden-md">Notifications</p>
                                </a>
                                <ul class="dropdown-menu">
                                    <li>
                                        <a href="#">Mike John responded to your email</a>
                                    </li>
                                    <li>
                                        <a href="#">You have 5 new tasks</a>
                                    </li>
                                    <li>
                                        <a href="#">You're now friend with Andrew</a>
                                    </li>
                                    <li>
                                        <a href="#">Another Notification</a>
                                    </li>
                                    <li>
                                        <a href="#">Another One</a>
                                    </li>
                                </ul>
                            </li>
                            <li>
                                <a href="#pablo" class="dropdown-toggle" data-toggle="dropdown">
                                    <i class="material-icons">person</i>
                                    <p class="hidden-lg hidden-md">Profile</p>
                                </a>
                            </li>
                        </ul>
                        <form class="navbar-form navbar-right" role="search">
                            <div class="form-group  is-empty">
                                <input type="text" class="form-control" placeholder="Search">
                                <span class="material-input"></span>
                            </div>
                            <button type="submit" class="btn btn-white btn-round btn-just-icon">
                                <i class="material-icons">search</i>
                                <div class="ripple-container"></div>
                            </button>
                        </form>
                    </div>
                </div>
            </nav>


		<div class="content">
			
			<div class="row">
			    <div class="col-md-12 ">

		        	<div class="panel-group fit-to-table" id="accordion" role="tablist" aria-multiselectable="true" >
					  	<div class="panel panel-default">
					    	<div class="panel-heading search-options-header" role="tab" id="headingOne">
					      		<h4 class="panel-title" role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="true" aria-controls="collapseOne" id="search-options-view-trigger">
					          		<span class="arrow_up_icon">Hide</span> <span class="arrow_down_icon custom-hide">Show</span> Statistics and Search Options
					          		<i class="material-icons pull-right arrow_up_icon">arrow_drop_up</i>
					          		<i class="material-icons pull-right custom-hide arrow_down_icon">arrow_drop_down</i>
					      		</h4>
					    	</div>
					    	<div id="collapseOne" class="panel-collapse collapse in search-options-body" role="tabpanel" aria-labelledby="headingOne">
						      	<div class="panel-body">
						      		<form id="frmSearch">
							      		<div class="row">
							      			<div class="col-md-6">	
							      				<h3>Statistics</h3>
							      				<div class="col-lg-6 col-md-6 col-sm-6">
						                            <div class="card card-stats">
						                                <div class="card-header" data-background-color="blue">
						                                    <i class="material-icons">note_add</i>
						                                </div>
						                                <div class="card-content">
						                                    <p>Ticket Sales</p>
						                                    <h3 class="title">90</h3>
						                                    <p class="category">No. of Tickets Sold</p>
						                                </div>
						                            </div>
		                        				</div>
		                        				<div class="col-lg-6 col-md-6 col-sm-6">
						                            <div class="card card-stats">
						                                <div class="card-header" data-background-color="blue">
						                                    <i class="material-icons">trending_up</i>
						                                </div>
						                                <div class="card-content">
						                                    <p>Total Sales</p>
						                                    <h3 class="title">₱472,967</h3>
						                                    <p class="category">Total Sales w/o AF + SF</p>
						                                </div>
						                            </div>
		                        				</div>
		                        				<div class="col-lg-6 col-md-6 col-sm-6">
						                            <div class="card card-stats">
						                                <div class="card-header" data-background-color="blue">
						                                    <i class="material-icons">check_circle</i>
						                                </div>
						                                <div class="card-content">
						                                    <p>Service Charge</p>
						                                    <h3 class="title">₱20,375</h3>
						                                    <p class="category">Main Admin Fee</p>
						                                </div>
						                            </div>
		                        				</div>
		                        				<div class="col-lg-6 col-md-6 col-sm-6">
						                            <div class="card card-stats">
						                                <div class="card-header" data-background-color="blue">
						                                    <i class="material-icons">free_breakfast</i>
						                                </div>
						                                <div class="card-content">
						                                    <p>Service Charge</p>
						                                    <h3 class="title">₱16,500</h3>
						                                    <p class="category">Customer Service Fee</p>
						                                </div>
						                            </div>
		                        				</div>
		                        				<div class="col-lg-6 col-md-6 col-sm-6">
						                            <div class="card card-stats">
						                                <div class="card-header" data-background-color="blue">
						                                    <i class="material-icons">star</i>
						                                </div>
						                                <div class="card-content">
						                                    <p>Total Cash Due</p>
						                                    <h3 class="title">₱509,842</h3>
						                                    <p class="category">Total Sales w/ AF + SF</p>
						                                </div>
						                            </div>
		                        				</div>
		                        				<div class="col-lg-6 col-md-6 col-sm-6">
						                            <div class="card card-stats">
						                                <div class="card-header" data-background-color="blue">
						                                    <i class="material-icons">favorite</i>
						                                </div>
						                                <div class="card-content">
						                                    <p>Total Remittance</p>
						                                    <h3 class="title">₱16,500</h3>
						                                    <p class="category">Total Sales w/ AF</p>
						                                </div>
						                            </div>
		                        				</div>
							      			</div>

							      			<div class="col-md-6">	
							      				<h3>Search Options</h3>
							      				<div class="col-md-12">
		                                            <div class="form-group label-floating is-empty">
		                                                <label class="control-label">Transaction ID</label>
		                                                <input type="text" name="trans_id" class="form-control custom-green-input">
		                                            	<span class="material-input"></span>
		                                        	</div>
		                                        </div>
		                                        <div class="col-md-12">
		                                            <div class="form-group label-floating is-empty">
		                                                <label class="control-label">Agency Name</label>
		                                                <input type="text" name="agency" class="form-control custom-green-input">
		                                            	<span class="material-input"></span>
		                                        	</div>
		                                        </div>
		                                        <div class="col-md-12">
		                                            <div class="form-group label-floating is-empty">
		                                                <label class="control-label">Customer</label>
		                                                <input type="text" name="txtCustomer" class="form-control custom-green-input">
		                                            	<span class="material-input"></span>
		                                        	</div>
		                                        </div>
		                                        <div class="col-md-12">
		                                            <div class="form-group label-floating is-empty">
			                                                <label class="control-label">Encoder</label>
			                                                <input type="text" name="txtEncoder" class="form-control custom-green-input">
			                                            <span class="material-input"></span>
			                                        </div>
			                                    </div>
								      			<div class="col-md-12">
			                                        <div class="form-group label-floating is-empty">
			                                            <label class="control-label">IATA Code</label>
			                                            <input type="text" name="txtIATACode" class="form-control custom-green-input">
			                                        	<span class="material-input"></span>
			                                    	</div>
			                                    </div>
			                                    <div class="col-md-12">
		                                            <div class="form-group label-floating is-empty">
		                                                <label class="control-label">Type</label>
		                                                <input type="text" name="txtType" class="form-control custom-green-input">
		                                            	<span class="material-input"></span>
		                                            	<br>
		                                        	</div>
		                                        </div>
		                                        <div class="col-md-12">
		                                        	<label class="">Date Range</label>
		                                        	<div id="reportrange" class="" style="background: #fff; cursor: pointer; padding: 5px 10px; border: 1px solid #ccc; width: 100%">
													    <i class="glyphicon glyphicon-calendar fa fa-calendar"></i>&nbsp;
													    <span></span> <b class="caret"></b>
													</div>
		                                        </div>
		                                        <div class="col-md-12">
		                                            <div class="form-group label-floating is-empty">
		                                            	<p class=" lblToggle">Enable Date Range</p>
		                                                <label class="switch" for="checkbox">
														   <input type="checkbox" name="tglDateRange" id="checkbox" />
														   <div class="slider round"></div>
														</label>
														<button type="submit" class="btn btn-success pull-right"><i class="material-icons">search</i> Search<div class="ripple-container"></div></button>
														<button class="btn pull-right btnCancel"><i class="material-icons">cancel</i> Cancel<div class="ripple-container"></div></button>
														
														  
		                                        	</div>
		                                        </div>
		                                        <div class="col-md-12">
		                                            <div class="form-group label-floating is-empty">
		                                            	
		                                        	</div>
		                                        </div>

		                                        
			                                 </div>


							      		</div>	
						      		</form>	
						      	</div>
					    	</div>
					  	</div>
					</div>

			    </div>
			</div>
            <div class="container-fluid">
                <div class="row">
                    <div class="col-md-12">
                        <div class="card ">
                            <div class="card-header" data-background-color="green">
                                <h4 class="title">Transactions List</h4>
                            </div>
                            <div class="card-content table-responsive">
                            	<button type="submit" class="btn btn-success"><i class="material-icons">print</i> Print</button>
                            	<div class="pull-right">
                            		<a class="table-filter-options btn btn-small table-filter-options-active" id="all">All</a>
                            		<a class="table-filter-options btn btn-small" id="declined">Declined</a>
                            		<a class="table-filter-options btn btn-small" id="approved">Approved</a>
                            		<a class="table-filter-options btn btn-small" id="pending">Pending</a>
	                            </div>
                                <table class="table table-hover">
                                    <thead>
                                        <th>ID</th>
                                        <th>Transaction Date</th>
                                        <th>Status</th>
                                        <th>Type</th>
                                        <th>System Reference</th>
                                        <th>Customer Name</th>
                                        <th>Airline</th>
                                        <th>NOP</th>
                                        <th>Agency</th>
                                        <th>BF</th>
                                        <th>AF</th>
                                        <th>SF</th>
                                        <th>Amount</th>
                                        <th>Encoder</th>
                                        <th>Actions</th>
                                    </thead>
                                    <tbody>
                                    	<% airlines.forEach(function(airline){ %>
									    	
									    	<tr>
	                                            <td><%= airline.id  %></td>
	                                            <td><%= airline.created_at  %></td>
	                                            <td><%= airline.flight_information.status  %></td>
	                                            <td><%= airline.sales_information.type  %></td>
	                                            <td><%= airline.flight_information.system_reference  %></td>
	                                            <td><%= airline.customer_information.display_name  %></td>
	                                            <td><%= airline.flight_information.airline.code  %></td>
	                                            <td><%= airline.passenger_list.length  %></td>
	                                            <td><%= airline.agency_information.name  %></td>
	                                            <td><%= airline.sales_information.amount  %></td>
	                                            <td><%= airline.sales_information.service_charge  %></td>
	                                            <td><%= airline.sales_information.service_fee  %></td>
	                                        	<td class="amounts"><%= parseInt(airline.sales_information.amount) + parseInt(airline.sales_information.service_charge) %></td>
	                                        	<td><%= airline.encoder_information.username  %></td>
	                                        	<td>
	                                        		<button class="btn btn-main btn-on-tables" rel="tooltip" data-placement="bottom" title="Info"><i class="material-icons" onclick="showNotification('top','right', 'sample', 'success');">info_outline</i></button>
	                                        		<button class="btn btn-main btn-on-tables" rel="tooltip" data-placement="bottom" title="Edit"><i class="material-icons" onclick="showNotification('top','right', 'sample', 'warning');">edit</i></button>
	                                        		<button class="btn btn-main btn-on-tables" rel="tooltip" data-placement="bottom" title="Print"><i class="material-icons" onclick="showNotification('top','right', 'sample', 'danger');">print</i></button>

	                                        	</td>
	                                            
	                                        </tr>

									  	<% }); %>
                                        
                                    </tbody>
                                </table>
                                <br>
                                <div class="constant-height">
	                                <a class="btn btn-success btn-on-tables btn-small btnPage" <% if (back == false) { %> style="display:none;" <% } %> moveTo="<%= back  %>"  id="btnBack"><i class="material-icons">navigate_before</i> Back</a>
	                                <a class="btn btn-success btn-on-tables btn-small pull-right btnPage" <% if (next == false) { %> style="display:none;" <% } %> moveTo="<%= next  %>" id="btnNext">Next <i class="material-icons">navigate_next</i></a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
	</div>



<% include ../partials/scripts %>  
<% include ../partials/dateRangePickerJS %>  
<script type="text/javascript">
	

	$( document ).ready(function() {

		var updateQueryStringParam = function (key, value) {

		    var baseUrl = [location.protocol, '//', location.host, location.pathname].join(''),
		        urlQueryString = document.location.search,
		        newParam = key + '=' + value,
		        params = '?' + newParam;

		    // If the "search" string exists, then build params from it
		    if (urlQueryString) {
		        var updateRegex = new RegExp('([\?&])' + key + '[^&]*');
		        var removeRegex = new RegExp('([\?&])' + key + '=[^&;]+[&;]?');

		        if( typeof value == 'undefined' || value == null || value == '' ) { // Remove param if value is empty
		            params = urlQueryString.replace(removeRegex, "$1");
		            params = params.replace( /[&;]$/, "" );

		        } else if (urlQueryString.match(updateRegex) !== null) { // If param exists already, update it
		            params = urlQueryString.replace(updateRegex, "$1" + newParam);

		        } else { // Otherwise, add it to end of query string
		            params = urlQueryString + '&' + newParam;
		        }
		    }

		    // no parameter was set so we don't need the question mark
		    params = params == '?' ? '' : params;

		    window.history.replaceState({}, "", baseUrl + params);
		};

		var getUrlParameter = function getUrlParameter(sParam) {
		    var sPageURL = decodeURIComponent(window.location.search.substring(1)),
		        sURLVariables = sPageURL.split('&'),
		        sParameterName,
		        i;

		    for (i = 0; i < sURLVariables.length; i++) {
		        sParameterName = sURLVariables[i].split('=');

		        if (sParameterName[0] === sParam) {
		            return sParameterName[1] === undefined ? true : sParameterName[1];
		        }
		    }
		};

		$('#search-options-view-trigger').click(function() {
			if ($('.arrow_up_icon').is(":visible")) {
				$('.arrow_up_icon').hide();
				$('.arrow_down_icon').show();
			}else{
				$('.arrow_down_icon').hide();
				$('.arrow_up_icon').show();
			}
			
		});


	    function format1(n, currency) {
		    return currency + " " + n.toFixed(2).replace(/./g, function(c, i, a) {
		        return i > 0 && c !== "." && (a.length - i) % 3 === 0 ? "," + c : c;
		    });
		};

		$('.amounts').each(function() {
		    var amount = $(this).html();
		    $(this).html(format1(parseInt(amount), "₱"));    
		});

		function refreshTable(){
			

			$.ajax({
			  	url:"./Airliness",
			  	type:"POST",
			  	data:{
			  		agency: getUrlParameter('agency') || '',
			    // 	customer: req.body.customer || '',
			    // 	encoder: req.body.encoder || '',
			    	start_date: getUrlParameter('start_date') || '',
			    	end_date: getUrlParameter('end_date') || '',
			    // 	iata_code: req.body.iata_code || '',
			    // 	limit: req.body.limit || '',
			    // 	customer: req.body.customer || '',
			    	status: getUrlParameter('status') || '',
			    	// ticket_type: req.body.ticket_type || '',
			    	trans_id: getUrlParameter('trans_id') || '',
			    	page: getUrlParameter('page') || '',
			  	},
			  	contentType:"application/x-www-form-urlencoded; charset=UTF-8",
			  	dataType:"json",
			  	success: function(response, status){
			    	$('tbody').empty();
			    	$(response.data).each(function(airline) { 
					    $('tbody').append(
					    	'<tr>'+
						    	'<td>'+response.data[airline].id+'</td>' +
						    	'<td>'+response.data[airline].created_at+'</td>' +
						    	'<td>'+response.data[airline].flight_information.status+'</td>' +
						    	'<td>'+response.data[airline].sales_information.type+'</td>' +
						    	'<td>'+response.data[airline].flight_information.system_reference+'</td>' +
						    	'<td>'+response.data[airline].customer_information.display_name+'</td>' +
						    	'<td>'+response.data[airline].flight_information.airline.code+'</td>' +
						    	'<td>'+response.data[airline].passenger_list.length+'</td>' +
						    	'<td>'+response.data[airline].agency_information.name+'</td>' +
						    	'<td>'+response.data[airline].sales_information.amount+'</td>' +
						    	'<td>'+response.data[airline].sales_information.service_charge+'</td>' +
						    	'<td>'+response.data[airline].sales_information.service_fee+'</td>' +
						    	'<td "class="amounts">'+parseInt(response.data[airline].sales_information.amount)+parseInt(response.data[airline].sales_information.service_charge)+'</td>' +
						    	'<td>'+response.data[airline].encoder_information.username+'</td>' +
						    	'<td>' +
						    		'<button class="btn btn-main btn-on-tables" rel="tooltip" data-placement="bottom" title="Info"><i class="material-icons">info_outline</i></button>'+
						    		'<button class="btn btn-main btn-on-tables" rel="tooltip" data-placement="bottom" title="Edit"><i class="material-icons">edit</i></button>' +
		                            '<button class="btn btn-main btn-on-tables" rel="tooltip" data-placement="bottom" title="Print"><i class="material-icons">print</i></button>' +
						    	'</td>'+
					    	'</tr>'                   	
					    );

					    if(response.prev != false){
					    	$("#btnBack").show();
					    	$("#btnBack").attr('moveTo', response.prev);
					    }else{
					    	$("#btnBack").hide();
					    	$("#btnBack").attr('moveTo', response.prev);
					    }
					    if(response.next != false){
					    	$("#btnNext").show();
					    	$("#btnNext").attr('moveTo', response.next);
					    }else{
					    	$("#btnNext").hide();
					    	$("#btnNext").attr('moveTo', response.next);
					    }
					});
			  	}
			})
		};

		$('form').submit(function( event ) {

			event.preventDefault(); 

			updateQueryStringParam('page', '');

			var values = {};
			$.each($(this).serializeArray(), function(i, field) {
				if(field.value != "" && field.value != "on" && field.value != "true") {
					console.log(field.name + ":" + field.value)
					updateQueryStringParam(field.name, field.value);
				}
			    
			});

			if($('#checkbox').val() === 'true'){
				updateQueryStringParam('start_date', startDate.format('YYYY-MM-DD'));
				updateQueryStringParam('end_date', endDate.format('YYYY-MM-DD'));
			}else{
				updateQueryStringParam('start_date', '');
				updateQueryStringParam('end_date', '');
			}

			

			refreshTable();
			
		});


		$(".table-filter-options").click(function(){
			var value = $(this).attr('id') || "";
			$(".table-filter-options").removeClass("table-filter-options-active")
			$(this).addClass("table-filter-options-active");
			if(value != 'all'){
				updateQueryStringParam('status', value);
			}else{
				updateQueryStringParam('status', '');
			}
			//updateQueryStringParam('page', '');
			//refreshTable();
		});

		$(".btnPage").click(function(){
			var value = $(this).attr('moveTo') || "";
			updateQueryStringParam('page', value);
			refreshTable();
		});

		$("#checkbox").click(function(){
			if($('#checkbox').val() != 'true') {
				$('#checkbox').val('true');
			}else{
				$('#checkbox').val('on');
			}
		});
		

	});


</script>

<% include ../partials/footer %>